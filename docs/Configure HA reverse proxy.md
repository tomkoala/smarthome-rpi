# Configure reverse Proxy for Home Assistant

Configuring Home Assistant to run via a reverse proxy, such as Nginx, allows you to expose Home Assistant via a public domain with SSL. Here's how you can configure Home Assistant to work properly behind a reverse proxy. Cerbot will be used to obain a free SSL certificate from Let's Encrypt.

## Prepare the required containers

Create a new docker-compose `web.yml` file and add the `nginx` and `certbot` services

``` yml
version: '3'
services:
  nginx:
    container_name: nginx
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"    
    volumes:
      - ${DATADIR}/volumes/nginx/html:/usr/share/nginx/html
      - ${DATADIR}/conf/nginx/nginx.conf:/etc/nginx/nginx.conf
      - letsencrypt-certs:/etc/letsencrypt
      - letsencrypt-www:/var/www/certbot
    restart: always
    network_mode: host
  certbot:
    container_name: certbot
    image: certbot/certbot
    volumes:
      - letsencrypt-certs:/etc/letsencrypt
      - letsencrypt-www:/var/www/certbot
      - ${DATADIR}/logs/letsencrypt:/var/log/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    network_mode: host

volumes:
  letsencrypt-www:
  letsencrypt-certs:
```

Certbot setup :

- ./letsencrypt-certs : Contains the certificates and keys generated by Certbot
- entrypoint : Defines a command to renew SSL certificates every 12 hours.

## Generate SSL certificates with Certbot

> :memo: **Prerequisites:**
>
> Make sure your domain previously created for instance with Dynamic DNS (DDNS) is pointed to your server. Configuration has to be performed in your router

First of all, you need to start Nginx with the default configuration (**without SSL**) so that Certbot can validate the domain.

```
docker-compose -f web.yml up -d nginx
```

To generate SSL certificates for the first time, you need to run Certbot manually with the following command :

```
docker-compose -f web.yml run --rm certbot certonly --webroot --webroot-path=/var/www/certbot -d your-domain.com
```

Replace `your-domain.com` with your real domain. This command will generate the SSL certificates and place them in the `./certs` folder.
You should see files like `fullchain.pem` and `privkey.pem` in `./certs/live/your-domain.com/`.

## Configure Nginx for SSL

Configuration of Nginx is made through the `nginx.conf` file. Below is the setup used to manage SSL with Let's Encrypt.

```
events {}

http {
    server {
        listen 80;
        server_name koalant.ddns.net;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 ssl;
        server_name koalant.ddns.net;

        ssl_certificate /etc/letsencrypt/live/koalant.ddns.net/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/koalant.ddns.net/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers HIGH:!aNULL:!MD5;

        location / {
            proxy_pass http://localhost:8123;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
```

**Configuration details**

`server { listen 80; ... }`

The HTTP server redirects all requests to HTTPS.
The `/.well-known/acme-challenge/` location block enables Certbot to verify the domain and generate SSL certificates.

`server { listen 443 ssl; ... }`

This server listens on port 443 for HTTPS traffic.

- server_name your-domain.com : Replace your-domain.com with your real domain.
- ssl_certificate and ssl_certificate_key: Indicate the paths of certificates generated by Let's Encrypt.
- ssl_protocols and ssl_ciphers: Configure protocols and cipher suites to secure connections.
- proxy_pass http://localhost:8123 : Nginx redirects requests to the Home Assistant server running locally on port 8123.
- proxy_buffering off : Disable proxy buffering to ensure that Home Assistant transmits responses in real time, which is particularly important for notifications and live streams.

Finally restart Nginx to apply the new settings enabling SSL

```
docker-compose -f web.yml restart nginx
```

## Configure Home Assistant

Home Assistant requires a few adjustments to work properly behind a reverse proxy. You need to specify the proxy headers in the Home Assistant configuration (configuration.yaml).

Add the following parameters in your configuration.yaml file:

```yaml
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1
    - ::1
```

**Configuration details**

- use_x_forwarded_for: true : enables the use of the X-Forwarded-For header to obtain the IP address of the original client, which is important for logging and security purposes.
- trusted_proxies: : tells Home Assistant to trust the specified proxies (here 127.0.0.1 and ::1 for localhost). If Nginx is running on another machine, you must add the IP address of that machine.

## Start the containers

Once the SSL certificates have been generated and the Nginx configuration updated, start your services with :

```
docker-compose -f web.yml up -d
docker-compose -f home-assistant.yml up -d
```

This will start Nginx, Home Assistant and Certbot. You can access Home Assistant via https://your-domain.com. Nginx will automatically redirect HTTP traffic to HTTPS.

## Force renewal of certificate

Stop first the Nginx server since TCP port 80 must be available for Certbot

```
docker-compose -f web.yml stop nginx
```

Then call certbot to renew the existing certificates

The `force-renewal` option tells Certbot to request a new certificate with the same domains as an existing certificate.

> Reference docs :
> - https://eff-certbot.readthedocs.io/en/stable/using.html#managing-certificates

```
docker-compose -f web.yml run --rm certbot certonly --force-renewal
```

Or directly through the container's shell

```
certbot certonly --force-renewal
```

Check in the certbot data directory that certificates has been renewed and start Nginx again

```
docker-compose -f web.yml start nginx
```